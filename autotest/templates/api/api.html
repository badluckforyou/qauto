<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{{ title }}</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="{% static 'vendors/iconfonts/mdi/css/materialdesignicons.css' %}">
    <!-- endinject -->
    <!-- vendor css for this page -->
    <!-- End vendor css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="{% static 'css/shared/style.css' %}">
    <!-- endinject -->
    <!-- Layout style -->
    <link rel="stylesheet" href="{% static 'css/demo_1/style.css' %}">
    <!-- Layout style -->
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" />
    <script type="text/javascript">
      window.onload = function(){
        $("#project").val("{{ project }}");
        $("#platform").val("{{ platform }}");
      }
    </script>
  </head>
  <body class="header-fixed" id="thebody">
    <!-- partial:partials/_header.html -->
    <nav class="t-header">
      <div class="t-header-brand-wrapper">
        <a>
          <img class="logo" src="{% static 'images/logo.png' %}" alt="">
          <img class="logo-mini" src="{% static 'images/logo_mini.png' %}" alt="">
        </a>
      </div>
      <div class="t-header-content-wrapper">
        <div class="t-header-content">
          <button class="t-header-toggler t-header-mobile-toggler d-block d-lg-none">
            <i class="mdi mdi-menu"></i>
          </button>
          <form action="#" class="t-header-search-box">
            <div class="input-group">
              <input type="text" class="form-control" id="inlineFormInputGroup" placeholder="Search" autocomplete="off">
              <button class="btn btn-primary" type="submit"><i class="mdi mdi-arrow-right-thick"></i></button>
            </div>
          </form>
          <ul class="nav ml-auto">
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="notificationDropdown" data-toggle="dropdown" aria-expanded="false">
                <i class="mdi mdi-account mdi-1x">{{ username }}</i>
              </a>
              <div class="dropdown-menu navbar-dropdown dropdown-menu-right" aria-labelledby="notificationDropdown" style="width: 130px;">
                <div class="dropdown-body">
                  <div class="dropdown-list">
                    <div class="rounded-circle bg-inverse-primary text-primary">
                    </div>
                    <div class="content-wrapper" onclick="location.href='/user/';">
                      <small class="content-text">My information</small>
                    </div>
                  </div>
                  <div class="dropdown-list" onclick="location.href='/login/';">
                    <div class="rounded-circle bg-inverse-warning text-warning">
                    </div>
                    <div class="content-wrapper">
                      <small class="content-text">Logout</small>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- partial -->
    <div class="page-body">
      <!-- partial:partials/_sidebar.html -->
      <div class="sidebar">
        <div class="user-profile">
          <div class="display-avatar animated-avatar">
            <img class="profile-img img-lg rounded-circle" src="{% static 'images/image.png' %}" alt="profile image">
          </div>
          <div class="info-wrapper">
            <h3 class="user-name">{{ company }}</h3>
          </div>
        </div>
        <ul class="navigation-menu">
          <li class="nav-category-divider">HOME</li>
          <li>
            <a href="/home/">
              <span class="link-title">主页</span>
              <i class="mdi mdi-home link-icon"></i>
            </a>
          </li>
          <li class="nav-category-divider">AUTOMATED TESTING</li>
          <li>
            <a href="/automation/">
              <span class="link-title">自动化测试</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li>
            <a href="/automation/result/">
              <span class="link-title">结果</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li class="nav-category-divider">API TESTING</li>
          <li>
            <a>
              <span class="link-title">接口测试</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li>
            <a href="/api/result/">
              <span class="link-title">结果</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li class="nav-category-divider">STRESS TESTING</li>
          <li>
            <a href="/stress/">
              <span class="link-title">压力测试</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li>
            <a href="/stress/result/">
              <span class="link-title">结果</span>
              <i class="mdi mdi-application link-icon"></i>
            </a>
          </li>
          <li class="nav-category-divider">USER</li>
          <li>
            <a href="/user/">
              <span class="link-title">My Information</span>
              <i class="mdi mdi-account link-icon"></i>
            </a>
          </li>
        </ul>
      </div>
      <!-- partial -->
      <div class="page-content-wrapper">
        <div class="page-content-wrapper-inner">
          <div class="content-viewport">
            <div class="row">
              <div class="modal" id="requestHeaders" data-backdrop="true" style="position: fixed;">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h6 class="modal-title">
                        <strong>Headers</strong>
                      </h6>
                    </div>
                    <div class="modal-body">
                      <label>以JSON的形式写入Headers</label>
                      <textarea class="form-control" rows="10" cols="10" id="headers"></textarea>
                    </div>
                    <div class="modal-footer">
                      <a class="btn btn-success btn-sm" id="clearHeaders">
                        Clear
                      </a>
                      <a class="btn btn-success btn-sm" data-dismiss="modal">
                        Save
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal" id="details" data-backdrop="true" style="position: fixed;">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content" id="report_content">
                    <div class="modal-header">
                      <h6 class="modal-title" style="font-size: 20px">
                        <strong>Details</strong>
                      </h6>
                    </div>
                    <div class="modal-body">
                      <label style="font-size: 18px;">发送数据</label>
                      <div>
                        <textarea class="form-control" id="sendData" rows="15" style="width: 99%; color: #bd4147" readonly></textarea>
                      </div>
                      <label>&nbsp;</label>
                      <div></div>
                      <label style="font-size: 18px;">接收数据</label>
                      <div>
                        <textarea class="form-control" id="recvData" rows="20" style="width: 99%;" readonly></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 equel-grid">
                <div class="grid">
                  <div class="grid-body py-3">
                    <div class="split-header">
                      <p class="card-title">Request</p>
                    </div>
                  </div>
                  <div class="vertical-timeline-wrapper">
                    <div class="row mb-3">
                      <div class="col-md-11 mx-auto">
                        <div class="form-group row showcase_row_area">
                          <!-- <div class="col-md-2 showcase_text_area">
                            <select class="custom-select" id="" name="methods" style="padding: 0 15px;height: 30px;">
                              {% for method in methods %}
                              <option>{{ method }}</option>
                              {% endfor %}
                            </select>
                          </div> -->
                          <div class="col-md-10 showcase_text_area">
                            <select id="methods" name="methods" style="padding: 0 15px;height: 30px;width: 15%;float: left;border-right-style: none;">
                              {% for method in methods %}
                              <option>{{ method }}</option>
                              {% endfor %}
                            </select>
                            <select id="dataType" name="dataType" style="padding: 0 15px;height: 30px;width: 15%;float: left;border-left-style: none;">
                              {% for type in datatype %}
                              <option>{{ type }}</option>
                              {% endfor %}
                            </select>
                            <input type="text" name="targetUrl" id="targetUrl" placeholder="请输入目标地址, 如:http://www.baidu.com" style="padding: 0 15px;height: 30px;width: 69%;float: left;">
                          </div>
                          <div class="col-md-2 showcase_text_area">
                            <button class="btn btn-success component-flat" id="startTest" style="padding: 0 15px;height: 30px;width: 99%">
                              发送
                            </button>
                          </div>
                          <!-- <div class="col-md-1 showcase_text_area">
                            <button class="btn action-btn btn-xs component-flat" data-toggle="modal" data-target="#requestHeaders">
                              <i class="mdi mdi-settings text-muted mdi-2x"></i>
                            </button>
                          </div> -->
                        </div>
                        <div class="form-group row showcase_row_area">
                          <div class="col-md-12 showcase_content_area">
                            <label>Headers</label>
                          </div>
                          <div class="col-md-10 showcase_content_area">
                            <input id="headerType" name="headerType" value="Content-Type" style="width: 20%;" readonly>
                            <select id="headerBody" name="headerBody" style="padding: 0 15px;height: 30px;width: 79%;">
                              <option>application/json;charset=UTF-8</option>
                              <option>application/x-www-form-urlencoded;charset=utf-8</option>
                              <option>text/plain</option>
                            </select>
                          </div>
                          <div class="col-md-2 showcase_text_area">
                            <button class="btn btn-inverse-primary component-flat" data-toggle="modal" data-target="#requestHeaders" style="padding: 0 15px;height: 30px;width: 99%">
                              自定义
                            </button>
                          </div>
                        </div>
                        <div class="form-group row showcase_row_area">
                          <div class="col-md-12 showcase_content_area">
                            <label>Data </label>
                            <textarea class="form-control" rows="20" id="requestData" style="font-size: 15px; color: #000000; font-family:courier;">{
    'opera': 'test',
    'userid': 10000,
    'username': 'tester',
    'child|data': {
        'info': true,
        'return': false
    },
    'remember': false
}</textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="grid-body py-3" id="randomTitle">
                    <div class="split-header">
                      <p class="card-title">Monkey Test</p>
                        <button type="button" class="btn btn-trasnparent action-btn btn-xs component-flat pr-0" id="removeRandom">
                          <i class="mdi mdi-window-close text-muted mdi-2x"></i>
                        </button>
                    </div>
                  </div>
                  <div class="vertical-timeline-wrapper" id="randomWrapper">
                    <div class="row mb-3">
                      <div class="col-md-11 mx-auto">
                        <div class="form-group row showcase_row_area">
                          <div class="col-md-12 showcase_content_area">
                            <label>随机次数</label>
                            <label>
                              <input class="form-control" type="" name="randomTimes" id="randomTimes" value="0" style="width: 70px;">
                            </label>
                            <label>
                              <span class="btn btn-trasnparent action-btn btn-xs component-flat pr-0" data-toggle="tooltip" data-placement="right" title="执行x次api测试">
                                <i class="mdi mdi-information-outline text-muted mdi-2x"></i>
                              </span>
                            </label>
                            <textarea class="form-control" rows="15" id="randomData" style="font-size: 15px; color: #000000; font-family:courier">// 若要添加带有, ()'|\字符的测试数据, 需要在字符前添加\
// string类型的测试数据, 需以''包裹
// random_between, 从1至100随机取值, 仅用于int/float类型
userid: random_between(1, 100)
// random_in, 从各个值中随机取值
username: random_in('t', 't\,e', 'tes', 'te\ st', 'te\(ste', 'tes\)ter','tes\[ter','tes\]ter')
// x|y, 在{'x':{'y': z}}中改变z的值; in_order, 按顺序取值
child\|data|info: in_order(true, 'true', 'True', false, 'false', 'False')
// in_order, 按顺序取值
remember: in_order(true, false)
</textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 equel-grid">
                <div class="grid">
                  <div class="grid-body py-3">
                    <div class="split-header">
                      <p class="card-title">Response</p>
                    </div>
                  </div>
                  <div class="form-group row showcase_row_area" id="responseData">
                    <pre class="text-gray" style="font-size: 14px;"><h6><br><br>     Empty data.</h6></pre>
                  </div>
                  <div style="float: right;" id="tableSheet"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- page content ends -->
    </div>
    <!--page body ends -->
    <!-- SCRIPT LOADING START FORM HERE /////////////-->
    <!-- plugins:js -->
    <script src="{% static 'vendors/js/core.js' %}"></script>
    <!-- endinject -->
    <!-- Vendor Js For This Page Ends-->
    <script src="{% static 'vendors/apexcharts/apexcharts.min.js' %}"></script>
    <script src="{% static 'vendors/chartjs/Chart.min.js' %}"></script>
    <script src="{% static 'js/charts/chartjs.addon.js' %}"></script>
    <!-- Vendor Js For This Page Ends-->
    <!-- build:js -->
    <script src="{% static 'js/template.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
    <!-- endbuild -->
    <script type="text/javascript">
      $(window).on("load", function(){
      });
      var halfWindowHeight = $(window).height() / 2;
      /****** 设置modal 显示的坐标 ******/
      function setModalHeight(modal, height){
        modal.css("display", "block");
        modal.css({
          "margin-top": height,
        });
      }
      $("#requestHeaders").on("show.bs.modal", function(e){
        var modalHeight = $(this).height();
        var windowHeight = $(window).height();
        setModalHeight($(this), (modalHeight - windowHeight) / 2);
      });
      $("#details").on("show.bs.modal", function(e){
        var modalHeight = $(this).height();
        var windowHeight = $(window).height();
        console.log(modalHeight, windowHeight);
        setModalHeight($(this), (modalHeight - windowHeight) / 4);
      });
      $("#removeRandom").click(function(){
        $("#ramdomTimes").val("");
        $("#randomData").val("");
        $("#randomWrapper").css("display", "none");
        $("#randomTitle").css("display", "none");
      });
      $("#clearHeaders").click(function(){
        $("#headers").val("");
      });
      $("#startTest").click(function(){
        var method = $("#methods").val();
        var dataType = $("#dataType").val();
        var targetUrl = $("#targetUrl").val();
        var requestData = $("#requestData").val();
        if (targetUrl == ""){
          alert("请输入目标地址!")
          return
        }
        if ($("#headers").val() != ""){
          var headers = $("#headers").val();
        }
        else {
          var dict = {};
          dict[$("#headerType").val()] = $("#headerBody").val();
          var headers = JSON.stringify(dict);
        }
        if ($("#randomWrapper").css("display") == "block"){
          var randomTimes = $("#randomTimes").val();
          var randomData = $("#randomData").val();
        }
        else {
          var randomTimes = "";
          var randomData = "";
        }
        $.ajax({
          cache: false,
          url: "request/",
          dataType: 'text',
          type: 'POST',
          async: true,
          data: {
            "method": method,
            "url": targetUrl,
            "headers": headers,
            "data": requestData,
            "dataType": dataType,
            "randomData": randomData,
            "randomTimes": randomTimes,
          },
          success: function(data){
            // 置为全局变量
            result = JSON.parse(data);
            // 默认显示第1页
            showRecv(result, 1);
          }
        });
      });
      /*** 根据后端返回的数据生成对应的结果表及跳转页签 ***/
      function showRecv(data, thisPage){
        var splitIdent = 18;
        var totalPage = Math.floor(data.length / splitIdent);
        if (totalPage != (data.length / splitIdent)){
          totalPage += 1;
        }
        if (thisPage == 1 && thisPage == totalPage){
          var startIdent = 0;
          var endIdent = data.length;
          var tableSheet = `
            <span>First </span>&nbsp;|
            <span>Previous </span>&nbsp;|
            <span>Next </span>&nbsp;|
            <span>Last </span>&nbsp;|
            &nbsp;Page&nbsp;<span>` + thisPage + `</span>/<span>` + totalPage + `</span>`
        }
        else if (thisPage == 1 && thisPage != totalPage){
          var startIdent = 0;
          var endIdent = splitIdent;
          var tableSheet = `
            <span>First </span>&nbsp;|
            <span>Previous </span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + (thisPage + 1 ) + `)">Next </a></span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + totalPage + `)">Last </a></span>&nbsp;|
            &nbsp;Page&nbsp;<span>` + thisPage + `</span>/<span>` + totalPage + `</span>`
        }
        else if (thisPage != 1 && thisPage != totalPage){
          var startIdent = (thisPage - 1) * splitIdent;
          var endIdent = thisPage * splitIdent;
          var tableSheet = `
            <span><a href="javascript:void(0);" onclick="goPage(1)">First </a></span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + (thisPage - 1 ) + `)">Previous </a></span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + (thisPage + 1 ) + `)">Next </a></span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + totalPage + `)">Last </a></span>&nbsp;|
            &nbsp;Page&nbsp;<span>` + thisPage + `</span>/<span>` + totalPage + `</span>`
        }
        else if (thisPage != 1 && thisPage == totalPage){
          var startIdent = (thisPage - 1) * splitIdent;
          var endIdent = data.length;
          var tableSheet = `
            <span><a href="javascript:void(0);" onclick="goPage(1)">First </a></span>&nbsp;|
            <span><a href="javascript:void(0);" onclick="goPage(` + (thisPage - 1 ) + `)">Previous </a></span>&nbsp;|
            <span>Next </span>&nbsp;|
            <span>Last </span>&nbsp;|
            &nbsp;Page&nbsp;<span>` + thisPage + `</span>/<span>` + totalPage + `</span>`
        }
        var htmlData = `
          <table id="table" name="table" class="table table-hover table-sm">
            <thead>
              <tr class="solid-header">
                <th style="width: 100px;">开始时间</th>
                <th style="width: 50px;">状态码</th>
                <th style="width: 50px;">耗时</th>
                <th style="width: 150px;">发送数据</th>
                <th style="width: 200px;">返回数据</th>
                <th style="width: 50px;"></th>
              </tr>
            </thead>
            <tbody>`
        for (var i=startIdent; i<endIdent; i++){
          htmlData += `
              <tr class="solid-header" id="` + i + `">
                <td style = "word-wrap:break-word;white-space:normal;">`+ data[i]["run_time"] + `</td>
                <td style = "word-wrap:break-word;white-space:normal;">`+ data[i]["status_code"] + `</td>
                <td style = "word-wrap:break-word;white-space:normal;">`+ data[i]["duration"] + `</td>
                <td style = "word-wrap:break-word;white-space:normal;">`+ data[i]["send_data"].toString().substring(0, 25) + ` ...</td>
                <td style = "word-wrap:break-word;white-space:normal;">`+ JSON.stringify(data[i]["recv_data"]).substring(0, 50) + ` ...</td>
                <td><label class="badge badge-success" type="button" data-toggle="modal" data-target="#details" onclick="showMore(`+ i + `)">详细信息</label></td>
              </tr>`
        }
        htmlData += `
            </tbody>
          </table>`
        // 生成结果表
        $("#responseData").html(htmlData);
        // 生成跳转页签
        $("#tableSheet").html(tableSheet);
        // staus code状态码颜色调整
        $("table tr").each(function(){
          var statusCode = $(this).find("td:eq(1)");
          if (statusCode.text() != 200){
            statusCode.css("color", "#f5003a");
          }
          else {
            statusCode.css("color", "#4CCEAC");
          }
        });
      }
      function showMore(i){
        var sendData = JSON.stringify(JSON.parse(result[i]["send_data"]), null, 4);
        console.log(result[i]["recv_data"].substring(0, 1))
        if (result[i]["recv_data"].substring(0, 1) == "{") {
          var recvData = JSON.stringify(JSON.parse(result[i]["recv_data"]), null, 4);
        } else {
          var recvData = result[i]["recv_data"];
        }
        $("#sendData").html(sendData);
        // $("#sendData").html(result[i]["send_data"]);
        $("#recvData").val(recvData);
      }
      function goPage(page){
        showRecv(result, page);
      }
    </script>
  </body>
</html>